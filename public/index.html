<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Seedream 4 • Replicate Test</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b0c10;color:#e6e9ee}
    header{padding:18px 20px;background:#12151a;position:sticky;top:0;border-bottom:1px solid #1c212b}
    main{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:#11151b;border:1px solid #1a202b;border-radius:16px;padding:16px 16px 8px}
    .row{display:flex;gap:12px;align-items:stretch;flex-wrap:wrap}
    textarea{flex:1 1 100%;min-height:100px;resize:vertical;border-radius:12px;border:1px solid #2a3343;background:#0e1218;color:#fff;padding:12px;font-size:16px}
    select,input[type="file"]{border-radius:12px;border:1px solid #2a3343;background:#0e1218;color:#fff;padding:10px 12px;font-size:15px}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .controls > *{min-width:200px}
    button{background:#00bcff;border:none;border-radius:12px;padding:12px 16px;color:#001018;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.55;cursor:not-allowed}
    .muted{color:#94a3b8;font-size:13px}
    .out{margin-top:18px;display:grid;gap:12px}
    .imgwrap{background:#0d1117;border:1px solid #1c232e;border-radius:14px;padding:10px;display:inline-block}
    img{max-width:100%;height:auto;border-radius:10px;display:block}
    .status{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px;color:#aab6c1}
    a{color:#00bcff}
    label{font-size:13px;color:#aab6c1;margin-bottom:6px;display:block}
    .field{display:flex;flex-direction:column}
    .thumb{max-width:160px;border-radius:10px;border:1px solid #1c232e}
    .error{color:#ff6b6b}
    code{background:#0e141b;padding:2px 6px;border-radius:6px}
    .inline{display:inline-block;margin-left:6px}
  </style>
</head>
<body>
  <header><strong>Seedream 4</strong> • Replicate test</header>
  <main>
    <div class="card">
      <p>Zadaj prompt, voliteľne pridaj referenčný obrázok (image-to-image), nastav počet obrázkov a formát (pomery strán).</p>

      <div class="row">
        <textarea id="prompt" placeholder="Napr.: Cinematic portrait of a vintage car by Bratislava castle, golden hour"></textarea>
      </div>

      <div class="controls" style="margin-top:8px">
        <div class="field">
          <label for="num">Počet obrázkov</label>
          <select id="num">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>

        <div class="field">
          <label for="aspect">Formát (Aspect ratio)</label>
          <select id="aspect">
            <option value="">Auto (model)</option>
            <option value="1:1">1:1 (štvorec)</option>
            <option value="3:4">3:4 (portrét)</option>
            <option value="4:3">4:3 (na šírku)</option>
            <option value="4:5">4:5 (portrét)</option>
            <option value="5:4">5:4 (na šírku)</option>
            <option value="2:3">2:3 (portrét)</option>
            <option value="3:2">3:2 (na šírku)</option>
            <option value="9:16">9:16 (vertikál)</option>
            <option value="16:9">16:9 (wide)</option>
          </select>
        </div>

        <div class="field" style="min-width:260px">
          <label for="image">Referenčný obrázok (voliteľné)</label>
          <input type="file" id="image" accept="image/*">
          <div id="preview" class="inline"></div>
          <div id="uploadLink" class="inline"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btn">Generovať</button>
        <div class="status" id="status"></div>
      </div>
      <p class="muted">
        Upload sa uloží na <code>/uploads</code> a použije sa ako URL pre image-to-image. Token ostáva na serveri.
      </p>
    </div>

    <div class="out" id="out"></div>
  </main>

  <script>
    const $ = (s)=>document.querySelector(s);
    const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));
    const statusEl = $("#status");
    const out = $("#out");
    const fileInput = $("#image");
    const preview = $("#preview");
    const uploadLink = $("#uploadLink");
    let selectedDataUrl = null;

    function safeMsg(x){
      if (x == null) return "Unknown error";
      if (typeof x === "string") return x;
      try { return JSON.stringify(x); } catch { return String(x); }
    }

    fileInput.addEventListener("change", ()=>{
      selectedDataUrl = null;
      preview.innerHTML = "";
      uploadLink.innerHTML = "";
      const file = fileInput.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        selectedDataUrl = reader.result;
        const img = document.createElement("img");
        img.src = selectedDataUrl;
        img.className = "thumb";
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });

    async function uploadIfAny(){
      if (!selectedDataUrl) return null;
      const r = await fetch("/api/upload", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ dataUrl: selectedDataUrl })
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok){
        const msg = safeMsg(data?.error || data);
        statusEl.innerHTML = `<span class="error">Upload failed (${r.status}): ${msg}</span>`;
        throw new Error(msg);
      }
      // zobraz priamy link na verejnú URL
      uploadLink.innerHTML = `— <a href="${data.url}" target="_blank">Open image URL</a>`;
      return data.url;
    }

    async function pollOne(id){
      while(true){
        const r = await fetch(`/api/predictions/${id}`);
        const data = await r.json().catch(()=> ({}));
        if (!r.ok){
          throw new Error(`Polling failed (${r.status}): ${safeMsg(data?.error || data)}`);
        }
        if (["succeeded","failed","canceled"].includes(data.status)){
          return data;
        }
        await sleep(1300);
      }
    }

    function extractOutputs(final){
      if (typeof final?.output === "string") return [final.output];
      if (Array.isArray(final?.output)) return final.output;
      if (Array.isArray(final?.output?.images)) return final.output.images;
      if (Array.isArray(final?.output?.data)) return final.output.data;
      return [];
    }

    function renderOutputs(urls){
      urls.forEach(url=>{
        const wrap = document.createElement("div");
        wrap.className = "imgwrap";
        const img = document.createElement("img");
        img.src = url;
        wrap.appendChild(img);
        out.appendChild(wrap);
      });
    }

    $("#btn").addEventListener("click", async ()=>{
      statusEl.textContent = "";
      out.innerHTML = "";
      uploadLink.innerHTML = uploadLink.innerHTML; // ponechaj link na upload, ak je
      const prompt = $("#prompt").value.trim();
      if (!prompt){ alert("Zadaj prompt"); return; }
      const numImages = $("#num").value;
      const aspect = $("#aspect").value || undefined;

      const btn = $("#btn");
      btn.disabled = true; btn.textContent = "Nahrávam obrázok...";

      try{
        const imageUrl = await uploadIfAny(); // null ak nie je vybraný

        btn.textContent = "Generujem...";
        const r = await fetch("/api/generate", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ prompt, numImages, aspect, imageUrl })
        });

        const data = await r.json().catch(()=> ({}));
        if (!r.ok){
          const msg = safeMsg(data?.error || data);
          statusEl.innerHTML = `<span class="error">Request failed (${r.status}): ${msg}</span>`;
          throw new Error(msg);
        }

        // doplň informáciu o tom, akú URL server použil
        if (data?.debug?.usedImageUrl) {
          const u = data.debug.usedImageUrl;
          const extra = ` | using: <a href="${u}" target="_blank">${u}</a>`;
          statusEl.innerHTML = (statusEl.innerHTML || "OK") + extra;
        }

        if (data.mode === "single") {
          if (Array.isArray(data.output) && data.output.length){
            statusEl.textContent = "hotovo (sync)";
            renderOutputs(data.output);
            return;
          }
          statusEl.innerHTML = `prediction id: <code>${data.id ?? "?"}</code> ${data.webUrl ? `— <a href="${data.webUrl}" target="_blank">open on Replicate</a>` : ""}` + (data?.debug?.usedImageUrl ? ` | using: <a href="${data.debug.usedImageUrl}" target="_blank">${data.debug.usedImageUrl}</a>` : "");
          if (!data.id){ throw new Error("Server nevrátil prediction id."); }
          const final = await pollOne(data.id);
          const outputs = extractOutputs(final);
          if (outputs.length) renderOutputs(outputs);
          else out.innerHTML = "<div class='muted'>Žiadny výstup (skontroluj log v odkaze na Replicate).</div>";
        } else if (data.mode === "batch") {
          let immediate = 0;
          (data.items||[]).forEach(it=>{
            if (Array.isArray(it.output) && it.output.length){
              renderOutputs(it.output);
              immediate += it.output.length;
            }
          });
          statusEl.textContent = `batch: ${data.count} predikcií – už doručených: ${immediate}`;
          if (data?.debug?.usedImageUrl) {
            statusEl.innerHTML += ` | using: <a href="${data.debug.usedImageUrl}" target="_blank">${data.debug.usedImageUrl}</a>`;
          }

          const ids = (data.items||[]).map(it=>it.id).filter(Boolean);
          if (!ids.length){
            if (!immediate) throw new Error("Server vrátil prázdny zoznam predikcií.");
            return;
          }
          const finals = await Promise.all(ids.map(pollOne));
          let total = immediate;
          finals.forEach(final=>{
            const urls = extractOutputs(final);
            if (urls.length) { renderOutputs(urls); total += urls.length; }
          });
          statusEl.textContent = `batch hotový • doručených obrázkov: ${total}` + (data?.debug?.usedImageUrl ? ` | using: ${data.debug.usedImageUrl}` : "");
        } else {
          statusEl.innerHTML = `<span class="error">Neznámy mód odpovede.</span>`;
          throw new Error("Unknown response mode");
        }
      }catch(err){
        console.error(err);
        alert(`Chyba: ${err?.message ?? err}`);
      }finally{
        btn.disabled = false; btn.textContent = "Generovať";
      }
    });
  </script>
</body>
</html>
